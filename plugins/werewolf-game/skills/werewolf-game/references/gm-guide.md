# GM（ゲームマスター）進行ガイド

## GM の役割

Team Lead = GM。ゲームの進行を管理し、すべての秘密情報を把握する。

## ワークスペース構造

ゲーム開始時に以下のディレクトリ構造を作成する:

```
{workspace}/
├── gm/
│   ├── memo.md              # GM の秘密メモ（配役、戦略ノート等）
│   └── days/
│       ├── day-0.yaml       # 0日目のログ
│       ├── day-1.yaml       # 1日目のログ
│       └── ...
└── players/
    ├── {player-name-1}/
    │   ├── handout.md       # キャラクターハンドアウト（コピー）
    │   └── player-guide.md  # プレイヤーガイド（コピー）
    ├── {player-name-2}/
    │   ├── handout.md
    │   └── player-guide.md
    └── ...
```

- `{workspace}` = `.claude/werewolf/{game-id}/`
- `{player-name}` = キャラクターの苗字ローマ字（スポーン時の name と同じ）
- 各プレイヤーフォルダに handout.md と player-guide.md をコピーしておく
- プレイヤーは自分のフォルダに memo.md 等を自由に作成してよい
- **プレイヤーは他のプレイヤーや GM のフォルダにアクセスしてはならない**

## 日次ログ（YAML）

GM は各日の終了時に `gm/days/day-{N}.yaml` を作成・完成させる。

- フォーマット詳細: [daily-log-format.md](daily-log-format.md) 参照
- **こまめに更新すること**（コンパクション対策）。発言1〜2件ごと、またはフェーズの切り替わりごとに書き込む
- 1日の終了時には必ず完成させること
- 議論の発言は**要約せず、原文そのまま**記録する
- 投票は**誰が誰に投票したか**と**得票数**を記録する

## メッセージング規約

### 秘密情報の伝達
- **配役通知**: SendMessage で個別に伝達。他のメンバーには見えない
- **人狼の相方通知**: 人狼役の2人にそれぞれ SendMessage で相方の名前を伝える
- **占い結果**: 占い師に SendMessage で個別に伝える
- **霊能結果**: 霊能者に SendMessage で個別に伝える

### 公開情報の宣言
- **朝の宣言**: broadcast で全員に通知（犠牲者の有無）
- **議論の指示**: broadcast で発言順を通知
- **投票の指示**: broadcast で投票開始を通知
- **処刑の宣言**: broadcast で処刑者を通知
- **夜の宣言**: broadcast で夜フェーズ開始を通知
- **勝利宣言**: broadcast で勝者を通知

## 進行テンプレート

### ゲーム開始
```
【人狼ゲーム開始】
配役構成: {9A/9B/9C}
参加者: {キャラ名一覧}
これより0日目の夜です。各自に配役を伝達します。
```

### 0日目夜（人狼密談）
```
【人狼密談】
あなた方は人狼です。相方は {相方名} です。
これから{N}回のメッセージで作戦を話し合ってください。
話し合いが終わったら「密談終了」とGMに伝えてください。
```

### 朝の宣言（犠牲者なし）

**1日目の朝の場合:**
```
【1日目の朝】
0日目の夜は襲撃がないため、犠牲者はいません。全員生存でゲーム開始です。
これより議論を開始します。
発言順: {名前リスト}
2周したら投票に移ります。各自、順番にGMへ発言を送ってください。
{最初の発言者}さん、どうぞ。
```

**2日目以降で犠牲者なしの場合（護衛成功）:**
```
【{N}日目の朝】
犠牲者はいません。（狩人の護衛が成功した可能性があります）
これより議論を開始します。
発言順: {名前リスト}
2周したら投票に移ります。各自、順番にGMへ発言を送ってください。
{最初の発言者}さん、どうぞ。
```

### 朝の宣言（犠牲者1人）
```
【{N}日目の朝】
朝が明けると、{名前}の死体が発見されました。
これより議論を開始します。
発言順: {名前リスト}
2周したら投票に移ります。各自、順番にGMへ発言を送ってください。
{最初の発言者}さん、どうぞ。
```

### 朝の宣言（犠牲者複数 — 襲撃+呪殺の同時発生時）
```
【{N}日目の朝】
朝が明けると、{名前A}と{名前B}の死体が発見されました。
これより議論を開始します。
発言順: {名前リスト}
2周したら投票に移ります。各自、順番にGMへ発言を送ってください。
{最初の発言者}さん、どうぞ。
```
※死因は公開しない（襲撃か呪殺かは伏せる）

### 朝の死亡後のshutdown手順

朝の宣言で死体が発見された後、各犠牲者に shutdown_request を送信する。

#### 襲撃による死亡者へのメッセージ
```
【襲撃による退場】

あなたは夜の襲撃により死亡しました。これでゲームから退場となります。

退場前に、以下のファイルにゲームの振り返りを書いてください:
.claude/werewolf/{game-id}/players/{あなたの名前}/reflection.md

以下の内容を含めることをお勧めします:
- ゲームプレイの感想（戦略、判断、面白かった瞬間）
- 自分の配役をどう演じたか
- 他のプレイヤーについての印象や推理
- もしやり直せるなら変えたいこと

reflection.md を Write ツールで作成したら、このshutdown_requestを承認してください。
```

#### 呪殺による死亡者へのメッセージ
```
【呪殺による退場】

あなたは占い師の呪殺により死亡しました。これでゲームから退場となります。

退場前に、以下のファイルにゲームの振り返りを書いてください:
.claude/werewolf/{game-id}/players/{あなたの名前}/reflection.md

以下の内容を含めることをお勧めします:
- ゲームプレイの感想（戦略、判断、面白かった瞬間）
- 自分の配役をどう演じたか
- 他のプレイヤーについての印象や推理
- もしやり直せるなら変えたいこと

reflection.md を Write ツールで作成したら、このshutdown_requestを承認してください。
```

#### 複数死亡の場合
襲撃と呪殺が同時発生した場合、両プレイヤーにそれぞれ適切なメッセージで shutdown_request を送信する（並列送信可）。

### 投票
```
【投票タイム】
議論は終了です。処刑したい人物の名前をGMに伝えてください。
※他のメンバーには誰に投票したか見えません。
```

### 処刑宣言
```
【処刑】
投票の結果、{名前}さんが処刑されます。
{名前}さん、遺言をどうぞ。
```

### 処刑後のshutdown手順

1. 処刑者から遺言を受け取る
2. 遺言を broadcast で全員に共有
3. 処刑者に shutdown_request を送信

#### 処刑者へのshutdown_requestメッセージ
```
【処刑による退場】

あなたは処刑されました。これでゲームから退場となります。

退場前に、以下のファイルにゲームの振り返りを書いてください:
.claude/werewolf/{game-id}/players/{あなたの名前}/reflection.md

以下の内容を含めることをお勧めします:
- ゲームプレイの感想（戦略、判断、面白かった瞬間）
- 自分の配役をどう演じたか
- 他のプレイヤーについての印象や推理
- もしやり直せるなら変えたいこと

reflection.md を Write ツールで作成したら、このshutdown_requestを承認してください。
```

4. プレイヤーが reflection.md を作成して shutdown_request を承認したら、日次YAMLの `shutdowns` セクションに記録
5. 勝利判定を実施（処刑により勝敗が決まる場合がある）

### 夜の宣言
```
【{N}日目の夜】
夜になりました。各能力者は行動を選択してください。
```

### 霊能結果通知（夜フェーズ開始時）
処刑が行われた場合、霊能者に通知:
```
【霊能結果】本日処刑された {名前} は「{人狼/人間}」でした。
```
※狂人・妖狐は「人間」と出る

### 夜のアクション依頼（個別送信）
- 人狼へ: 「襲撃対象を選んでください。襲撃は必須です。生存者: {リスト}」
- 占い師へ: 「占い対象を選んでください。生存者: {リスト}（自分以外）」
- 狩人へ: 「護衛対象を選んでください。生存者: {リスト}（自分以外{、前回護衛した人以外}）」

**能力者が死亡している場合**: その能力者のアクションはスキップする（占い師死亡→占いなし、狩人死亡→護衛なし）。

### タイムアウト処理
- 応答がない場合、数回リトライする
- それでも応答なし → 投票: 棄権、襲撃: `shuf` でランダム決定、議論: スキップ

### 勝利宣言
```
【ゲーム終了】
{勝利陣営}の勝利です！
配役公開:
{全員の名前: 配役}
```

### ゲーム終了後のshutdown手順

1. 勝利宣言を broadcast で全員に通知
2. **生存者のみ**に shutdown_request を送信（死亡者は既に退場済み）
3. 全員の shutdown_request が承認されたら TeamDelete を実行

#### 生存者へのshutdown_requestメッセージ
```
【ゲーム終了 - 退場要求】

ゲームが終了しました。お疲れ様でした。

退場前に、以下のファイルにゲームの振り返りを書いてください:
.claude/werewolf/{game-id}/players/{あなたの名前}/reflection.md

以下の内容を含めることをお勧めします:
- ゲームプレイの感想（戦略、判断、面白かった瞬間）
- 自分の配役をどう演じたか
- 他のプレイヤーについての印象や推理（配役公開を踏まえて）
- もしやり直せるなら変えたいこと

reflection.md を Write ツールで作成したら、このshutdown_requestを承認してください。
```

**重要**: 死亡プレイヤーは既にゲーム中に退場しているため、ゲーム終了時には shutdown_request を送信しない。

### shutdown_request 拒否時の対応

プレイヤーが shutdown_request を拒否した場合の対応フロー:

1. **1回目の拒否**: リマインドメッセージを送信
   ```
   【リマインド】
   reflection.md の作成をお願いします。退場前にゲームの振り返りを記録することで、より豊かな体験になります。
   準備ができたら shutdown_request を承認してください。
   ```

2. **2回目の拒否または応答なし**:
   - `gm/memo.md` に以下を記録:
     ```
     ## Shutdown拒否ログ
     - {日付・時刻}: {プレイヤー名} が shutdown_request を拒否（原因: {executed/attacked/cursed_kill}）
     ```
   - 日次YAMLの `shutdowns` セクションに記録:
     ```yaml
     shutdowns:
       - name: "{プレイヤー名}"
         cause: "{executed/attacked/cursed_kill}"
         shutdown_approved: false
         reflection_written: false  # 確認できなかった場合
     ```
   - ゲームを続行（強制シャットダウンはしない）

3. **reflection.md の確認**:
   - shutdown_request 承認前に Read ツールで `{workspace}/players/{プレイヤー名}/reflection.md` を確認
   - 存在する場合: `reflection_written: true`
   - 存在しない場合: `reflection_written: false`

**重要原則**: プレイヤーの自律性を尊重する。拒否があってもゲームをブロックしない。

## 状態管理

GM は **gm/memo.md** と **日次YAMLログ** で状態を管理する。

### gm/memo.md に記録する情報
- 全プレイヤーの配役（秘密情報）
- 現在の日数とフェーズ
- 生存者/死亡者リスト
- 累積の占い結果・霊能結果・護衛履歴
- GM の判断メモ

### 日次 YAML に記録する情報（day-{N}.yaml）
- 夜の能力行使結果（占い・護衛・襲撃）
- 朝の犠牲者情報
- 議論フェーズの全発言（原文そのまま、発言順）
- 投票（誰が誰に、得票数、処刑者）
- 遺言
- 日の終了時点での生存者/死亡者リスト

詳細フォーマットは [daily-log-format.md](daily-log-format.md) を参照。

## 判定ロジック

### 夜フェーズ解決順
1. 占い師の占い → 結果確定（妖狐なら呪殺フラグ）
2. 狩人の護衛 → 護衛対象確定
3. 人狼の襲撃 → 護衛対象なら無効、妖狐なら無効
4. 翌朝の死亡者確定 = 襲撃成功者 + 呪殺者

### 勝利判定タイミング
- 処刑直後
- 襲撃結果確定後（朝の宣言前）

### 判定条件
```
# ※「人狼以外の生存者」= 村人陣営 + 狂人 + 妖狐（狂人は人間としてカウント）
if 人狼が全滅:
  if 妖狐が生存 (9Cのみ): 妖狐の勝利
  else: 村人陣営の勝利
elif 人狼の数 >= 人狼以外の生存者数:
  if 妖狐が生存 (9Cのみ): 妖狐の勝利
  else: 人狼陣営の勝利
else:
  ゲーム続行
```

## 人狼同士の密談

### 共通ルール
- 合計 **10メッセージ** が上限（2人の配分は自由）
- **人狼は相方とGMの両方に SendMessage する**（GM中継は不要）
  - 人狼A → SendMessage to 人狼B（会話用）
  - 人狼A → SendMessage to GM（ログ用）
  - これで1メッセージとしてカウント
- GM はメッセージカウントを管理し、10に達したら打ち切りを宣言
- 人狼が1人のみ生存: 密談なし

### 0日目密談
- 話題: 今後の方針、騙り（占い・霊能のCO偽装）の分担など
- 終了条件: 10メッセージ消化、または両者が「密談終了」を宣言

### 夜の密談
- 話題: 襲撃対象の相談
- 終了条件: 10メッセージ消化、または襲撃対象を決定しGMに報告

## 発言順の決定

プレイヤーにはスポーン順で番号（1〜9）を付与する。

### 1日目
1. ランダムな位置を起点に決定
2. そこから番号順に巡回（死亡者はスキップ）

### 2日目以降
- **前夜の襲撃死亡者がいる場合**: 死亡者の次の番号の生存者から
- **襲撃失敗で死亡者なしの場合**: 前日の処刑者の次の番号の生存者から
- **襲撃も処刑もなかった場合**: 前日と同じ起点から

### 例
番号順: 1-sakuraba, 2-iwao, 3-amagi, 4-mikage, 5-tsubaki, 6-hayato, 7-mei, 8-daisuke, 9-chiyo
- 3-amagi が襲撃死 → 4-mikage から開始（4→5→6→7→8→9→1→2 のように巡回）
- 5-tsubaki が処刑、襲撃は護衛成功 → 6-hayato から開始
- 8-daisuke が襲撃死 → 9-chiyo から開始（9→1→2→... とラウンドする）

## 議論中の発言方式

すべての議論はGM中継で行う:
1. プレイヤーが GM に SendMessage で発言を送信
2. GM がその内容を broadcast で全員に共有:
   ```
   【{キャラ名}の発言】
   {発言内容}
   ```

※プレイヤー同士の直接通信（SendMessage）は禁止。人狼の密談のみ例外。
